-----Type


create or replace TYPE "LGD_CALCULATION" AS OBJECT (
    ACCOUNT_NUMBER     VARCHAR2(1000),
    DATE_OF_DEFAULT     VARCHAR2(1000),
    GROUP_NAME   VARCHAR2(1000),
    LOAN_OUTSTANDING VARCHAR2(1000),
    EFFECTIVE_INTEREST_RATE VARCHAR2(1000),
    DATE_1 VARCHAR2(1000),
    DATE_2 VARCHAR2(1000),
    DATE_3 VARCHAR2(1000),
    DATE_4 VARCHAR2(1000),
    DATE_5 VARCHAR2(1000),
    DATE_6 VARCHAR2(1000),
    DATE_7 VARCHAR2(1000),
    DATE_8 VARCHAR2(1000),
    DATE_9 VARCHAR2(1000),
    DATE_10 VARCHAR2(1000),
    DATE_11 VARCHAR2(1000),
    DATE_12 VARCHAR2(1000),
    DATE_13 VARCHAR2(1000),
    DATE_14 VARCHAR2(1000),
    DATE_15 VARCHAR2(1000),
    DATE_16 VARCHAR2(1000),
    DATE_17 VARCHAR2(1000),
    DATE_18 VARCHAR2(1000),
    DATE_19 VARCHAR2(1000),
    DATE_20 VARCHAR2(1000),
    DATE_21 VARCHAR2(1000),
    DATE_22 VARCHAR2(1000),
    DATE_23 VARCHAR2(1000),
    DATE_24 VARCHAR2(1000),
    DATE_25 VARCHAR2(1000),
    DATE_26 VARCHAR2(1000),
    DATE_27 VARCHAR2(1000),
    DATE_28 VARCHAR2(1000),
    DATE_29 VARCHAR2(1000),
    DATE_30 VARCHAR2(1000),
    DATE_31 VARCHAR2(1000),
    DATE_32 VARCHAR2(1000),
    DATE_33 VARCHAR2(1000),
    DATE_34 VARCHAR2(1000),
    DATE_35 VARCHAR2(1000),
    DATE_36 VARCHAR2(1000),
    TOTAL_COLLECTIONS VARCHAR2(1000),
    PV_TOTAL_COLLECTIONS VARCHAR2(1000),
    LOSS_GIVEN_DEFAULT NUMBER(38, 2),
    ORDERID VARCHAR2(3)
);



------------------




create or replace TYPE "LGD_CALCULATION_TABLE" AS
    TABLE OF LGD_CALCULATION;


-------------------



create or replace TYPE "PD_CALCULATION" AS OBJECT (
    PERIOD     DATE,
    TOTAL_LOAN_PORTFOLIO     NUMBER(38, 2),
    FROM_1_30_DPD   NUMBER(38, 2),
    FROM_31_60_DPD  NUMBER(38, 2),
    FROM_61_90_DPD   NUMBER(38, 2),
    MORE_TAHN_90_DPD  NUMBER(38, 2),
    OFFICE_NAME  VARCHAR2(1000),
    GROUP_NAME VARCHAR2(1000),
    PERIOD_2 DATE,
    FROM_1_30_DPD_RATE NUMBER(38,2),
    FROM_31_60_DPD_RATE NUMBER(38, 2),
    FROM_61_90_DPD_RATE NUMBER(38, 2),
    MORE_THAN_90_DPD  NUMBER(38, 2)
);


----------------------



create or replace TYPE "PD_CALCULATION_TABLE" AS
    TABLE OF PD_CALCULATION;



--------------------


create or replace TYPE "IMPAIRMENT_CALCULATION" AS OBJECT (
   LOAN_GROUP_ID NUMBER(38),
   LOAN_GROUP_NAME VARCHAR2(1000),
   AVGOF_FROM_1_30_DPD_RATE NUMBER(38, 2),
   AVGOF_FROM_31_60_DPD_RATE NUMBER(38, 2),
   AVGOF_FROM_61_90_DPD_RATE NUMBER(38, 2),
   AVGOF_MORE_THAN_90_DPD_RATE NUMBER(38, 2),
   TOTAL_AVGOF_DPD_RATE NUMBER(38, 2),
   LGD_OFFICE_RATE NUMBER(38, 10),
   EAD_NET_OUTSTANDING_LAON NUMBER(38, 2),
   IMPAIRMENT NUMBER(38, 2)
   
);


------------------------


create or replace TYPE "IMPAIRMENT_CALCULATION_TABLE" AS
    TABLE OF IMPAIRMENT_CALCULATION;




------Function


create or replace FUNCTION CALCULATING_COLLECTION_IN_PERIOD (
COLLECTIVE_PD_DATE IN DATE,
LOANACCOUNT IN VARCHAR2
) RETURN NUMBER IS RESULT_COLLECTION NUMBER(38, 2) := 0;

BEGIN
SELECT NVL(SUM(NVL(VNSD.PRINCIPAL,0)),0) INTO RESULT_COLLECTION FROM v_new_schedule_detail VNSD
WHERE vnsd.schedule_status = 2
AND (vnsd.isrevers  = 0 OR vnsd.isrevers IS NULL)
AND vnsd.loan_account = LOANACCOUNT
AND vnsd.payment_date BETWEEN TRUNC(COLLECTIVE_PD_DATE, 'mm') AND LAST_DAY(COLLECTIVE_PD_DATE);
RETURN RESULT_COLLECTION;
END;

-------------



create or replace FUNCTION CALCULATING_DPD (
NUM1 IN NUMBER,
NUM2 IN NUMBER
) RETURN NUMBER IS RESULTDPD NUMBER(38, 2) := 0;

BEGIN
IF (NUM1 > 0) THEN
 SELECT NVL(NUM2, 0) / NVL(NUM1, 0)
    INTO RESULTDPD FROM DUAL;
    if (RESULTDPD > 1) THEN SELECT 1 INTO RESULTDPD FROM DUAL;
    ELSIF (RESULTDPD < 0) THEN  SELECT 0 INTO RESULTDPD FROM DUAL;
    END IF;
ELSE SELECT 0 INTO RESULTDPD FROM DUAL;
END IF;
RETURN RESULTDPD;
END;

---------------


create or replace FUNCTION CALCULATING_LGD (
PERIODDATE IN DATE,
DEFUALTDATE IN DATE,
LOANACCOUNT VARCHAR2,
IRRRATE IN NUMBER
) RETURN NUMBER IS RESULTLGD NUMBER(38, 2) := 0;

BEGIN
IF (PERIODDATE - DEFUALTDATE > 0) THEN
SELECT 
    nvl(CALCULATING_COLLECTION_IN_PERIOD(PERIODDATE, LOANACCOUNT),0) * nvl((POWER((1+IRRRATE), -((PERIODDATE - DEFUALTDATE)/365))),0) INTO RESULTLGD 
    FROM DUAL;
END IF;
RETURN RESULTLGD;
END;

------------------------


create or replace FUNCTION CALCULATING_LOSS_GIVEN (
PVTOTALCOLLECTION IN NUMBER,
OUTSTANDINGLOAN IN NUMBER
) RETURN NUMBER IS RESULTLGDLOSSGIVEN NUMBER(38, 2);

BEGIN

   SELECT 1 - (NVL(PVTOTALCOLLECTION, 0) / NVL(OUTSTANDINGLOAN, 0))
   INTO RESULTLGDLOSSGIVEN FROM DUAL;

   IF (RESULTLGDLOSSGIVEN < 0) THEN
    SELECT 0 INTO RESULTLGDLOSSGIVEN FROM DUAL;
    ELSIF (RESULTLGDLOSSGIVEN > 1) THEN 
    SELECT 1 INTO RESULTLGDLOSSGIVEN FROM DUAL;
    END IF;

RETURN RESULTLGDLOSSGIVEN;
END;


---------------------------------


create or replace FUNCTION GET_PERIOD_PD (
GROUPID IN NUMBER,
DATETH IN NUMBER
) RETURN DATE IS RESULT_PERIOD DATE;

BEGIN
    SELECT LAST_DAY(ADD_MONTHS(MAX(PERIOD_DATE), DATETH-35)) 
    INTO RESULT_PERIOD FROM m_collectivepd
    where collectivegroup_id = GROUPID;
RETURN RESULT_PERIOD;
END;


-----------------------------------

create or replace FUNCTION "LGD_CALCULATION_REPORT"(
OFFICEID IN NUMBER,
CURRENCY IN VARCHAR2,
TILLDATE IN DATE
) RETURN LGD_CALCULATION_TABLE IS
RETURN_VALUE LGD_CALCULATION_TABLE;
BEGIN
    SELECT
    LGD_CALCULATION(
        "ACCOUNT_NUMBER",
        "DATE_OF_DEFAULT",
        "GROUP_NAME",
        "LOAN_OUTSTANDING",
        "EFFECTIVE_INTEREST_RATE",
        "DATE_1",
        "DATE_2",
        "DATE_3",
        "DATE_4",
        "DATE_5",
        "DATE_6",
        "DATE_7",
        "DATE_8",
        "DATE_9",
        "DATE_10",
        "DATE_11",
        "DATE_12",
        "DATE_13",
        "DATE_14",
        "DATE_15",
        "DATE_16",
        "DATE_17",
        "DATE_18",
        "DATE_19",
        "DATE_20",
        "DATE_21",
        "DATE_22",
        "DATE_23",
        "DATE_24",
        "DATE_25",
        "DATE_26",
        "DATE_27",
        "DATE_28",
        "DATE_29",
        "DATE_30",
        "DATE_31",
        "DATE_32",
        "DATE_33",
        "DATE_34",
        "DATE_35",
        "DATE_36",
        "TOTAL_COLLECTIONS",
        "PV_TOTAL_COLLECTIONS",
        "LOSS_GIVEN_DEFAULT",
        "ORDERID"
    )
    BULK COLLECT
    INTO RETURN_VALUE
    FROM(
        select
*
from
(
    SELECT
    *
FROM
    (
        SELECT DISTINCT
            account_number                 account_number,
            date_of_default                date_of_default,
            group_name                     group_name,
            loan_outstanding               loan_outstanding,
            effective_interest_rate        effective_interest_rate,
            to_char(date_1, 'dd-MM-yyyy')  date_1,
            to_char(date_2, 'dd-MM-yyyy')  date_2,
            to_char(date_3, 'dd-MM-yyyy')  date_3,
            to_char(date_4, 'dd-MM-yyyy')  date_4,
            to_char(date_5, 'dd-MM-yyyy')  date_5,
            to_char(date_6, 'dd-MM-yyyy')  date_6,
            to_char(date_7, 'dd-MM-yyyy')  date_7,
            to_char(date_8, 'dd-MM-yyyy')  date_8,
            to_char(date_9, 'dd-MM-yyyy')  date_9,
            to_char(date_10, 'dd-MM-yyyy') date_10,
            to_char(date_11, 'dd-MM-yyyy') date_11,
            to_char(date_12, 'dd-MM-yyyy') date_12,
            to_char(date_13, 'dd-MM-yyyy') date_13,
            to_char(date_14, 'dd-MM-yyyy') date_14,
            to_char(date_15, 'dd-MM-yyyy') date_15,
            to_char(date_16, 'dd-MM-yyyy') date_16,
            to_char(date_17, 'dd-MM-yyyy') date_17,
            to_char(date_18, 'dd-MM-yyyy') date_18,
            to_char(date_19, 'dd-MM-yyyy') date_19,
            to_char(date_20, 'dd-MM-yyyy') date_20,
            to_char(date_21, 'dd-MM-yyyy') date_21,
            to_char(date_22, 'dd-MM-yyyy') date_22,
            to_char(date_23, 'dd-MM-yyyy') date_23,
            to_char(date_24, 'dd-MM-yyyy') date_24,
            to_char(date_25, 'dd-MM-yyyy') date_25,
            to_char(date_26, 'dd-MM-yyyy') date_26,
            to_char(date_27, 'dd-MM-yyyy') date_27,
            to_char(date_28, 'dd-MM-yyyy') date_28,
            to_char(date_29, 'dd-MM-yyyy') date_29,
            to_char(date_30, 'dd-MM-yyyy') date_30,
            to_char(date_31, 'dd-MM-yyyy') date_31,
            to_char(date_32, 'dd-MM-yyyy') date_32,
            to_char(date_33, 'dd-MM-yyyy') date_33,
            to_char(date_34, 'dd-MM-yyyy') date_34,
            to_char(date_35, 'dd-MM-yyyy') date_35,
            to_char(date_36, 'dd-MM-yyyy') date_36,
            total_collections              total_collections,
            'PV_TOTAL_COLLECTIONS'          PV_TOTAL_COLLECTIONS,
            null            LOSS_GIVEN_DEFAULT,
            'A'                            orderid
        FROM
            (
                SELECT
                    'Account Number'                         account_number,
                    'Date of Default'                        date_of_default,
                    'Group Name'                             group_name,
                    'Loan Outstanding'                       loan_outstanding,
                    'Effective Interest Rate'                effective_interest_rate,
                    get_period_pd(ml.collectivegroup_id, 1)  date_1,
                    get_period_pd(ml.collectivegroup_id, 2)  date_2,
                    get_period_pd(ml.collectivegroup_id, 3)  date_3,
                    get_period_pd(ml.collectivegroup_id, 4)  date_4,
                    get_period_pd(ml.collectivegroup_id, 5)  date_5,
                    get_period_pd(ml.collectivegroup_id, 6)  date_6,
                    get_period_pd(ml.collectivegroup_id, 7)  date_7,
                    get_period_pd(ml.collectivegroup_id, 8)  date_8,
                    get_period_pd(ml.collectivegroup_id, 9)  date_9,
                    get_period_pd(ml.collectivegroup_id, 10) date_10,
                    get_period_pd(ml.collectivegroup_id, 11) date_11,
                    get_period_pd(ml.collectivegroup_id, 12) date_12,
                    get_period_pd(ml.collectivegroup_id, 13) date_13,
                    get_period_pd(ml.collectivegroup_id, 14) date_14,
                    get_period_pd(ml.collectivegroup_id, 15) date_15,
                    get_period_pd(ml.collectivegroup_id, 16) date_16,
                    get_period_pd(ml.collectivegroup_id, 17) date_17,
                    get_period_pd(ml.collectivegroup_id, 18) date_18,
                    get_period_pd(ml.collectivegroup_id, 19) date_19,
                    get_period_pd(ml.collectivegroup_id, 20) date_20,
                    get_period_pd(ml.collectivegroup_id, 21) date_21,
                    get_period_pd(ml.collectivegroup_id, 22) date_22,
                    get_period_pd(ml.collectivegroup_id, 23) date_23,
                    get_period_pd(ml.collectivegroup_id, 24) date_24,
                    get_period_pd(ml.collectivegroup_id, 25) date_25,
                    get_period_pd(ml.collectivegroup_id, 26) date_26,
                    get_period_pd(ml.collectivegroup_id, 27) date_27,
                    get_period_pd(ml.collectivegroup_id, 28) date_28,
                    get_period_pd(ml.collectivegroup_id, 29) date_29,
                    get_period_pd(ml.collectivegroup_id, 30) date_30,
                    get_period_pd(ml.collectivegroup_id, 31) date_31,
                    get_period_pd(ml.collectivegroup_id, 32) date_32,
                    get_period_pd(ml.collectivegroup_id, 33) date_33,
                    get_period_pd(ml.collectivegroup_id, 34) date_34,
                    get_period_pd(ml.collectivegroup_id, 35) date_35,
                    to_date(TILLDATE)                       date_36,
                    'Total Collections'                      total_collections
                FROM
                         m_collectivepd mcpd
                    INNER JOIN m_loan ml ON ml.collectivegroup_id = mcpd.collectivegroup_id
                WHERE
                    mcpd.collectivegroup_id = ml.collectivegroup_id
            )
        UNION
        SELECT
            to_char(account_number)                account_number,
            to_char(date_of_default, 'dd-MM-yyyy') date_of_default,
            to_char(group_name)                    group_name,
            to_char(loan_outstanding)              loan_outstanding,
            to_char(effective_interest_rate)       effective_interest_rate,
            to_char(date_1)                        date_1,
            to_char(date_2)                        date_2,
            to_char(date_3)                        date_3,
            to_char(date_4)                        date_4,
            to_char(date_5)                        date_5,
            to_char(date_6)                        date_6,
            to_char(date_7)                        date_7,
            to_char(date_8)                        date_8,
            to_char(date_9)                        date_9,
            to_char(date_10)                       date_10,
            to_char(date_11)                       date_11,
            to_char(date_12)                       date_12,
            to_char(date_13)                       date_13,
            to_char(date_14)                       date_14,
            to_char(date_15)                       date_15,
            to_char(date_16)                       date_16,
            to_char(date_17)                       date_17,
            to_char(date_18)                       date_18,
            to_char(date_19)                       date_19,
            to_char(date_20)                       date_20,
            to_char(date_21)                       date_21,
            to_char(date_22)                       date_22,
            to_char(date_23)                       date_23,
            to_char(date_24)                       date_24,
            to_char(date_25)                       date_25,
            to_char(date_26)                       date_26,
            to_char(date_27)                       date_27,
            to_char(date_28)                       date_28,
            to_char(date_29)                       date_29,
            to_char(date_30)                       date_30,
            to_char(date_31)                       date_31,
            to_char(date_32)                       date_32,
            to_char(date_33)                       date_33,
            to_char(date_34)                       date_34,
            to_char(date_35)                       date_35,
            to_char(date_36)                       date_36,
            to_char(total_collections)             total_collections,
            'PV_TOTAL_COLLECTIONS'          PV_TOTAL_COLLECTIONS,
            null            LOSS_GIVEN_DEFAULT,
            'B'                                    orderid
        FROM
            (
                SELECT
                    mlgd.loanaccount                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       account_number,
                    mlgd.datedefault                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       date_of_default,
                    mcg.group_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         group_name,
                    vlc.netprincipal_oustanding                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            loan_outstanding,
                    vlc.irr_rate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           effective_interest_rate,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 1), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_1,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 2), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_2,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 3), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_3,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 4), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_4,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 5), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_5,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 6), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_6,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 7), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_7,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 8), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_8,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 9), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date_9,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 10), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_10,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 11), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_11,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 12), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_12,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 13), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_13,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 14), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_14,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 15), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_15,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 16), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_16,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 17), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_17,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 18), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_18,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 19), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_19,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 20), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_20,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 21), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_21,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 22), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_22,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 23), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_23,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 24), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_24,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 25), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_25,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 26), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_26,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 27), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_27,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 28), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_28,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 29), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_29,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 30), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_30,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 31), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_31,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 32), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_32,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 33), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_33,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 34), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_34,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 35), mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           date_35,
                    calculating_collection_in_period(TILLDATE, mlgd.loanaccount)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          date_36,
                    SUM(calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 1), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 2), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    3), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 4), mlgd.loanaccount) +
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 5), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 6), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    7), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 8), mlgd.loanaccount) +
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 9), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 10), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    11), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 12), mlgd.loanaccount) +
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 13), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 14), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    15), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 16), mlgd.loanaccount) +
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 17), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 18), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    19), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 20), mlgd.loanaccount) +
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 21), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 22), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    23), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 24), mlgd.loanaccount) +
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 25), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 26), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    27), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 28), mlgd.loanaccount) +
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 29), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 30), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    31), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 32), mlgd.loanaccount) +
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 33), mlgd.loanaccount) + calculating_collection_in_period(
                    get_period_pd(ml.collectivegroup_id, 34), mlgd.loanaccount) + calculating_collection_in_period(get_period_pd(ml.collectivegroup_id,
                    35), mlgd.loanaccount) + calculating_collection_in_period(TILLDATE, mlgd.loanaccount)) total_collections
                FROM
                         m_loan ml
                    INNER JOIN m_loan_lgd        mlgd ON mlgd.loanid = ml.id
                    INNER JOIN m_collectivegroup mcg ON mcg.id = ml.collectivegroup_id
                    INNER JOIN v_loan_cifrs      vlc ON vlc.loan_account = ml.account_no
                WHERE
                        mlgd.officeid = OFFICEID
                    AND mlgd.currency_code = CURRENCY
                GROUP BY
                    mlgd.loanaccount,
                    mlgd.datedefault,
                    mcg.group_name,
                    vlc.netprincipal_oustanding,
                    vlc.irr_rate,
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 1), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 2), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 3), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 4), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 5), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 6), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 7), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 8), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 9), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 10), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 11), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 12), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 13), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 14), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 15), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 16), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 17), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 18), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 19), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 20), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 21), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 22), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 23), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 24), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 25), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 26), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 27), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 28), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 29), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 30), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 31), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 32), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 33), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 34), mlgd.loanaccount),
                    calculating_collection_in_period(get_period_pd(ml.collectivegroup_id, 35), mlgd.loanaccount),
                    calculating_collection_in_period(TILLDATE, mlgd.loanaccount)
            )
    )
ORDER BY
    orderid)
    );
    
     RETURN return_value;
END;



--------------------------------


create or replace FUNCTION "LGD_CALCULATION_TYPE_2_REPORT"(
OFFICEID IN NUMBER,
CURRENCY IN VARCHAR2,
TILLDATE IN DATE
) RETURN LGD_CALCULATION_TABLE IS
RETURN_VALUE LGD_CALCULATION_TABLE;
BEGIN
    SELECT
    LGD_CALCULATION(
        "ACCOUNT_NUMBER",
        "DATE_OF_DEFAULT",
        "GROUP_NAME",
        "LOAN_OUTSTANDING",
        "EFFECTIVE_INTEREST_RATE",
        "DATE_1",
        "DATE_2",
        "DATE_3",
        "DATE_4",
        "DATE_5",
        "DATE_6",
        "DATE_7",
        "DATE_8",
        "DATE_9",
        "DATE_10",
        "DATE_11",
        "DATE_12",
        "DATE_13",
        "DATE_14",
        "DATE_15",
        "DATE_16",
        "DATE_17",
        "DATE_18",
        "DATE_19",
        "DATE_20",
        "DATE_21",
        "DATE_22",
        "DATE_23",
        "DATE_24",
        "DATE_25",
        "DATE_26",
        "DATE_27",
        "DATE_28",
        "DATE_29",
        "DATE_30",
        "DATE_31",
        "DATE_32",
        "DATE_33",
        "DATE_34",
        "DATE_35",
        "DATE_36",
        "TOTAL_COLLECTIONS",
        "PV_TOTAL_COLLECTIONS",
        "LOSS_GIVEN_DEFAULT",
        "ORDERID"
    )
    BULK COLLECT
    INTO RETURN_VALUE
    FROM(

        SELECT
*
FROM
(
SELECT DISTINCT
            account_number                 account_number,
            date_of_default                date_of_default,
            group_name                     group_name,
            loan_outstanding               loan_outstanding,
            effective_interest_rate        effective_interest_rate,
            to_char(date_1, 'dd-MM-yyyy')  date_1,
            to_char(date_2, 'dd-MM-yyyy')  date_2,
            to_char(date_3, 'dd-MM-yyyy')  date_3,
            to_char(date_4, 'dd-MM-yyyy')  date_4,
            to_char(date_5, 'dd-MM-yyyy')  date_5,
            to_char(date_6, 'dd-MM-yyyy')  date_6,
            to_char(date_7, 'dd-MM-yyyy')  date_7,
            to_char(date_8, 'dd-MM-yyyy')  date_8,
            to_char(date_9, 'dd-MM-yyyy')  date_9,
            to_char(date_10, 'dd-MM-yyyy') date_10,
            to_char(date_11, 'dd-MM-yyyy') date_11,
            to_char(date_12, 'dd-MM-yyyy') date_12,
            to_char(date_13, 'dd-MM-yyyy') date_13,
            to_char(date_14, 'dd-MM-yyyy') date_14,
            to_char(date_15, 'dd-MM-yyyy') date_15,
            to_char(date_16, 'dd-MM-yyyy') date_16,
            to_char(date_17, 'dd-MM-yyyy') date_17,
            to_char(date_18, 'dd-MM-yyyy') date_18,
            to_char(date_19, 'dd-MM-yyyy') date_19,
            to_char(date_20, 'dd-MM-yyyy') date_20,
            to_char(date_21, 'dd-MM-yyyy') date_21,
            to_char(date_22, 'dd-MM-yyyy') date_22,
            to_char(date_23, 'dd-MM-yyyy') date_23,
            to_char(date_24, 'dd-MM-yyyy') date_24,
            to_char(date_25, 'dd-MM-yyyy') date_25,
            to_char(date_26, 'dd-MM-yyyy') date_26,
            to_char(date_27, 'dd-MM-yyyy') date_27,
            to_char(date_28, 'dd-MM-yyyy') date_28,
            to_char(date_29, 'dd-MM-yyyy') date_29,
            to_char(date_30, 'dd-MM-yyyy') date_30,
            to_char(date_31, 'dd-MM-yyyy') date_31,
            to_char(date_32, 'dd-MM-yyyy') date_32,
            to_char(date_33, 'dd-MM-yyyy') date_33,
            to_char(date_34, 'dd-MM-yyyy') date_34,
            to_char(date_35, 'dd-MM-yyyy') date_35,
            to_char(date_36, 'dd-MM-yyyy') date_36,
            total_collections              total_collections,
            'PV TOTAL COLLECTIONS'          PV_TOTAL_COLLECTIONS,
            -1            LOSS_GIVEN_DEFAULT,
            'A'                            orderid
        FROM
            (
                SELECT
                    'Account Number'                         account_number,
                    'Date of Default'                        date_of_default,
                    'Group Name'                             group_name,
                    'Loan Outstanding'                       loan_outstanding,
                    'Effective Interest Rate'                effective_interest_rate,
                    get_period_pd(ml.collectivegroup_id, 1)  date_1,
                    get_period_pd(ml.collectivegroup_id, 2)  date_2,
                    get_period_pd(ml.collectivegroup_id, 3)  date_3,
                    get_period_pd(ml.collectivegroup_id, 4)  date_4,
                    get_period_pd(ml.collectivegroup_id, 5)  date_5,
                    get_period_pd(ml.collectivegroup_id, 6)  date_6,
                    get_period_pd(ml.collectivegroup_id, 7)  date_7,
                    get_period_pd(ml.collectivegroup_id, 8)  date_8,
                    get_period_pd(ml.collectivegroup_id, 9)  date_9,
                    get_period_pd(ml.collectivegroup_id, 10) date_10,
                    get_period_pd(ml.collectivegroup_id, 11) date_11,
                    get_period_pd(ml.collectivegroup_id, 12) date_12,
                    get_period_pd(ml.collectivegroup_id, 13) date_13,
                    get_period_pd(ml.collectivegroup_id, 14) date_14,
                    get_period_pd(ml.collectivegroup_id, 15) date_15,
                    get_period_pd(ml.collectivegroup_id, 16) date_16,
                    get_period_pd(ml.collectivegroup_id, 17) date_17,
                    get_period_pd(ml.collectivegroup_id, 18) date_18,
                    get_period_pd(ml.collectivegroup_id, 19) date_19,
                    get_period_pd(ml.collectivegroup_id, 20) date_20,
                    get_period_pd(ml.collectivegroup_id, 21) date_21,
                    get_period_pd(ml.collectivegroup_id, 22) date_22,
                    get_period_pd(ml.collectivegroup_id, 23) date_23,
                    get_period_pd(ml.collectivegroup_id, 24) date_24,
                    get_period_pd(ml.collectivegroup_id, 25) date_25,
                    get_period_pd(ml.collectivegroup_id, 26) date_26,
                    get_period_pd(ml.collectivegroup_id, 27) date_27,
                    get_period_pd(ml.collectivegroup_id, 28) date_28,
                    get_period_pd(ml.collectivegroup_id, 29) date_29,
                    get_period_pd(ml.collectivegroup_id, 30) date_30,
                    get_period_pd(ml.collectivegroup_id, 31) date_31,
                    get_period_pd(ml.collectivegroup_id, 32) date_32,
                    get_period_pd(ml.collectivegroup_id, 33) date_33,
                    get_period_pd(ml.collectivegroup_id, 34) date_34,
                    get_period_pd(ml.collectivegroup_id, 35) date_35,
                    to_date(TILLDATE)                       date_36,
                    'Total Collections'                      total_collections
                FROM
                         m_collectivepd mcpd
                    INNER JOIN m_loan ml ON ml.collectivegroup_id = mcpd.collectivegroup_id
                WHERE
                    mcpd.collectivegroup_id = ml.collectivegroup_id
            )
UNION

SELECT
 to_char(account_number)                account_number,
            to_char(date_of_default, 'dd-MM-yyyy') date_of_default,
            to_char(group_name)                    group_name,
            to_char(loan_outstanding)              loan_outstanding,
            to_char(effective_interest_rate)       effective_interest_rate,
            to_char(date_1)                        date_1,
            to_char(date_2)                        date_2,
            to_char(date_3)                        date_3,
            to_char(date_4)                        date_4,
            to_char(date_5)                        date_5,
            to_char(date_6)                        date_6,
            to_char(date_7)                        date_7,
            to_char(date_8)                        date_8,
            to_char(date_9)                        date_9,
            to_char(date_10)                       date_10,
            to_char(date_11)                       date_11,
            to_char(date_12)                       date_12,
            to_char(date_13)                       date_13,
            to_char(date_14)                       date_14,
            to_char(date_15)                       date_15,
            to_char(date_16)                       date_16,
            to_char(date_17)                       date_17,
            to_char(date_18)                       date_18,
            to_char(date_19)                       date_19,
            to_char(date_20)                       date_20,
            to_char(date_21)                       date_21,
            to_char(date_22)                       date_22,
            to_char(date_23)                       date_23,
            to_char(date_24)                       date_24,
            to_char(date_25)                       date_25,
            to_char(date_26)                       date_26,
            to_char(date_27)                       date_27,
            to_char(date_28)                       date_28,
            to_char(date_29)                       date_29,
            to_char(date_30)                       date_30,
            to_char(date_31)                       date_31,
            to_char(date_32)                       date_32,
            to_char(date_33)                       date_33,
            to_char(date_34)                       date_34,
            to_char(date_35)                       date_35,
            to_char(date_36)                       date_36,
            'total_collections'            total_collections,
            TO_CHAR(PV_TOTAL_COLLECTIONS)         PV_TOTAL_COLLECTIONS,
            calculating_loss_given(PV_TOTAL_COLLECTIONS, loan_outstanding) * 100            LOSS_GIVEN_DEFAULT,
            'B'                                    orderid
FROM(

SELECT
                    mlgd.loanaccount                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       account_number,
                    mlgd.datedefault                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       date_of_default,
                    mcg.group_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         group_name,
                    vlc.netprincipal_oustanding                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            loan_outstanding,
                    vlc.irr_rate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           effective_interest_rate,
                    calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 1),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_1,
                    calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 2),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_2,
                    calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 3),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_3,
                    calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 4),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_4,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 5),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_5,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 6),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_6,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 7),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_7,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 8),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_8,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 9),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_9,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 10),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_10,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 11),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_11,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 12),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_12,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 13),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_13,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 14),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_14,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 15),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_15,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 16),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_16,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 17),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_17,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 18),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_18,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 19),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_19,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 20),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_20,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 21),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_21,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 22),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_22,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 23),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_23,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 24),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_24,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 25),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_25,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 26),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_26,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 27),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_27,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 28),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_28,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 29),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_29,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 30),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_30,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 31),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_31,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 32),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_32,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 33),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_33,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 34),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_34,
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 35),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_35,
                     calculating_lgd(
                    TO_DATE(TILLDATE),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) DATE_36,

                    'TOTAL_COLLECTIONS' TOTAL_COLLECTIONS,
                    sum(
 calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 1),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                    calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 2),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                    calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 3),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                    calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 4),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 5),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 6),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 7),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 8),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 9),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 10),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 11),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 12),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 13),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 14),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 15),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 16),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 17),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 18),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 19),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 20),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 21),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 22),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 23),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 24),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 25),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 26),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 27),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 28),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 29),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 30),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 31),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 32),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 33),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 34),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    get_period_pd(ml.collectivegroup_id, 35),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                   ) +
                     calculating_lgd(
                    TO_DATE(TILLDATE),
                    mlgd.datedefault,
                    mlgd.loanaccount,
                    vlc.irr_rate
                    ) ) PV_TOTAL_COLLECTIONS


                FROM
                         m_loan ml
                    INNER JOIN m_loan_lgd        mlgd ON mlgd.loanid = ml.id
                    INNER JOIN m_collectivegroup mcg ON mcg.id = ml.collectivegroup_id
                    INNER JOIN v_loan_cifrs      vlc ON vlc.loan_account = ml.account_no
                WHERE
                        mlgd.officeid = OFFICEID
                    AND mlgd.currency_code = CURRENCY group by mlgd.loanaccount, mlgd.datedefault, mcg.group_name, vlc.netprincipal_oustanding, vlc.irr_rate, 
calculating_lgd( get_period_pd(ml.collectivegroup_id, 1), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 2), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 3), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 4), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 5), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), 
calculating_lgd( get_period_pd(ml.collectivegroup_id, 6), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 7), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 8), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 9), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 10), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), 
calculating_lgd( get_period_pd(ml.collectivegroup_id, 11), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 12), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 13), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 14), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 15), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), 
calculating_lgd( get_period_pd(ml.collectivegroup_id, 16), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 17), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 18), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 19), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 20), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), 
calculating_lgd( get_period_pd(ml.collectivegroup_id, 21), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 22), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 23), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 24), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 25), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), 
calculating_lgd( get_period_pd(ml.collectivegroup_id, 26), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 27), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 28), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 29), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 30), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), 
calculating_lgd( get_period_pd(ml.collectivegroup_id, 31), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 32), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 33), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 34), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), calculating_lgd( get_period_pd(ml.collectivegroup_id, 35), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), 
calculating_lgd( TO_DATE(TILLDATE), mlgd.datedefault, mlgd.loanaccount, vlc.irr_rate ), 'TOTAL_COLLECTIONS'
)     ) ORDER BY ORDERID        
    );



     RETURN return_value;
END;

-----------------------



create or replace FUNCTION "PD_CALCULATION_REPORT" (
    currentdate       IN DATE,
    collectivegroupid IN NUMBER,
    officeid          IN NUMBER
) RETURN pd_calculation_table IS
    return_value         pd_calculation_table;
    impairment_till_date DATE;
BEGIN
    SELECT
        MAX(impairment_till)
    INTO impairment_till_date
    FROM
        m_loan;

    IF ( currentdate <= impairment_till_date ) THEN
        SELECT 
            pd_calculation("PERIOD", "TOTAL_LOAN_PORTFOLIO", "FROM_1_30_DPD", "FROM_31_60_DPD", "FROM_61_90_DPD",
                           "MORE_TAHN_90_DPD", "OFFICE_NAME", "GROUP_NAME", "GROUP_ID", "PERIOD_2", "FROM_1_30_DPD_RATE",
                           "FROM_31_60_DPD_RATE", "FROM_61_90_DPD_RATE", "MORE_THAN_90_DPD_RATE")
        BULK COLLECT
        INTO return_value
        FROM
            (
                SELECT 
                    *
                FROM
                    (
                        SELECT
                            mcpd.period_date          period,
                            mcpd.total_loan_portfolio total_loan_portfolio,
                            mcpd.dpd1to30             from_1_30_dpd,
                            mcpd.dpd30to60            from_31_60_dpd,
                            mcpd.dpd60to90            from_61_90_dpd,
                            mcpd.dpdmorethan90        more_tahn_90_dpd,
                            mo.name                   office_name,
                            mcg.group_name            group_name,
                            MCG.ID GROUP_ID,
                            mcpd.period_date          period_2,
                            CASE
                                WHEN ( ROWNUM > 1 ) THEN
                                    calculating_dpd((
                                        SELECT
                                            total_loan_portfolio
                                        FROM
                                            m_collectivepd
                                        WHERE
                                                period_date = last_day(add_months(mcpd.period_date, - 1))
                                            AND collectivegroup_id = mcpd.collectivegroup_id
                                            AND officeid = officeid
                                    ),
                            --mcpd.total_loan_portfolio, 
                                     mcpd.dpd1to30)
                            END                       from_1_30_dpd_rate,
                            CASE
                                WHEN ( ROWNUM > 1 ) THEN
                                    calculating_dpd((
                                        SELECT
                                            dpd1to30
                                        FROM
                                            m_collectivepd
                                        WHERE
                                                period_date = last_day(add_months(mcpd.period_date, - 1))
                                            AND collectivegroup_id = mcpd.collectivegroup_id
                                            AND officeid = officeid
                                    ), mcpd.dpd30to60)
                            END                       from_31_60_dpd_rate,
                            CASE
                                WHEN ( ROWNUM > 1 ) THEN
                                    calculating_dpd((
                                        SELECT
                                            dpd30to60
                                        FROM
                                            m_collectivepd
                                        WHERE
                                                period_date = last_day(add_months(mcpd.period_date, - 1))
                                            AND collectivegroup_id = mcpd.collectivegroup_id
                                            AND officeid = officeid
                                    ), mcpd.dpd60to90)
                            END                       from_61_90_dpd_rate,
                            CASE
                                WHEN ( ROWNUM > 1 ) THEN
                                    calculating_dpd((
                                        SELECT
                                            dpd60to90
                                        FROM
                                            m_collectivepd
                                        WHERE
                                                period_date = last_day(add_months(mcpd.period_date, - 1))
                                            AND collectivegroup_id = mcpd.collectivegroup_id
                                            AND officeid = officeid
                                    ), mcpd.dpdmorethan90)
                            END                       more_than_90_dpd_RATE
                        FROM
                                 m_collectivepd mcpd
                            INNER JOIN m_office          mo ON mo.id = mcpd.officeid
                            INNER JOIN m_collectivegroup mcg ON mcg.id = mcpd.collectivegroup_id
                        WHERE
                            mcpd.collectivegroup_id = collectivegroupid
                            AND mo.id = officeid
                        UNION
                        SELECT
                            ( to_date(currentdate) ) AS period,
                            nvl(SUM(
                                CASE
                                    WHEN pd = 'PD0' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0)                    AS total_loan_portfolio,
                            nvl(SUM(
                                CASE
                                    WHEN pd = 'PD1' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0)                    AS from_1_30_dpd,
                            nvl(SUM(
                                CASE
                                    WHEN pd = 'PD2' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0)                    AS from_31_60_dpd,
                            nvl(SUM(
                                CASE
                                    WHEN pd = 'PD3' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0)                    AS from_61_90_dpd,
                            nvl(SUM(
                                CASE
                                    WHEN pd = 'PD4' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0)                    AS more_tahn_90_dpd,
                            office_name,
                            group_name,
                            GROUP_ID,
                            ( to_date(currentdate) ) AS period_2,
                            calculating_dpd(nvl((
                                SELECT
                                    total_loan_portfolio
                                FROM
                                    m_collectivepd
                                WHERE
                                        period_date = last_day(add_months(currentdate, - 1))
                                    AND collectivegroup_id = collectivegroupid
                                    AND officeid = officeid
                            ), 0), nvl(SUM(
                                CASE
                                    WHEN pd = 'PD1' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0))                   from_1_30_dpd_rate,
                            calculating_dpd(nvl((
                                SELECT
                                    dpd1to30
                                FROM
                                    m_collectivepd
                                WHERE
                                        period_date = last_day(add_months(currentdate, - 1))
                                    AND collectivegroup_id = collectivegroupid
                                    AND officeid = officeid
                            ), 0), nvl(SUM(
                                CASE
                                    WHEN pd = 'PD2' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0))                   from_31_60_dpd_rate,
                            calculating_dpd(nvl((
                                SELECT
                                    dpd30to60
                                FROM
                                    m_collectivepd
                                WHERE
                                        period_date = last_day(add_months(currentdate, - 1))
                                    AND collectivegroup_id = collectivegroupid
                                    AND officeid = officeid
                            ), 0), nvl(SUM(
                                CASE
                                    WHEN pd = 'PD3' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0))                   from_61_90_dpd_rate,
                            calculating_dpd(nvl((
                                SELECT
                                    dpd60to90
                                FROM
                                    m_collectivepd
                                WHERE
                                        period_date = last_day(add_months(currentdate, - 1))
                                    AND collectivegroup_id = collectivegroupid
                                    AND officeid = officeid
                            ), 0), nvl(SUM(
                                CASE
                                    WHEN pd = 'PD4' THEN
                                        nvl(oustanding, 0)
                                    ELSE
                                        0
                                END
                            ), 0))                   more_than_90_dpd_RATE
                        FROM
                            (
                                SELECT
                                    CASE
                                        WHEN nvl(vnsd.payment_date, last_day(currentdate)) - vns.due_date BETWEEN 1 AND 30  THEN
                                            'PD1'
                                        WHEN nvl(vnsd.payment_date, last_day(currentdate)) - vns.due_date BETWEEN 31 AND 60 THEN
                                            'PD2'
                                        WHEN nvl(vnsd.payment_date, last_day(currentdate)) - vns.due_date BETWEEN 61 AND 90 THEN
                                            'PD3'
                                        WHEN nvl(vnsd.payment_date, last_day(currentdate)) - vns.due_date >= 91             THEN
                                            'PD4'
                                        WHEN vnsd.payment_date - vns.due_date <= 0                                          THEN
                                            'PD0'
                                    END                                         AS pd,
                                    vlc.fair_value - nvl(vnss.principalpaid, 0) AS oustanding,
                                    mo.name                                     office_name,
                                    mcg.group_name,
                                    MCG.ID GROUP_ID
                                FROM
                                         v_new_schedule vns
                                    JOIN (
                                        SELECT
                                            MIN(due_date) AS due_date,
                                            loancifrs_id  AS loancifrs_id
                                        FROM
                                            v_new_schedule
                                        WHERE
                                            schedule_status <> 2
                                        GROUP BY
                                            loancifrs_id
                                    )                 vns1 ON vns.due_date = vns1.due_date
                                              AND vns.loancifrs_id = vns1.loancifrs_id
                                    JOIN m_loan            ml ON ml.account_no = vns.loan_account
                                    JOIN (
                                        SELECT
                                            to_date(currentdate) AS payment_date,
                                            due_date,
                                            oustanding           AS oustanding,
                                            loancifrs_id
                                        FROM
                                            v_new_schedule
                                    )                 vnsd ON vns1.due_date = vnsd.due_date
                                              AND vns1.loancifrs_id = vnsd.loancifrs_id
                                    JOIN v_loan_cifrs      vlc ON vlc.loan_account = vns.loan_account
                                    LEFT JOIN (
                                        SELECT
                                            SUM(principal) AS principalpaid,
                                            loancifrs_id   AS loancifrs_id
                                        FROM
                                            v_new_schedule_detail
                                        WHERE
                                                schedule_status = 2
                                            AND payment_date <= last_day(currentdate)
                                        GROUP BY
                                            loancifrs_id
                                    )                 vnss ON vnss.loancifrs_id = vlc.id
                                    JOIN m_client          mc ON ml.client_id = mc.id
                                    JOIN m_office          mo ON mc.office_id = mo.id
                                    INNER JOIN m_collectivegroup mcg ON mcg.id = ml.collectivegroup_id
                                WHERE
                                        mo.id = officeid
                                    AND ml.loan_status_id = 300
                                    AND ml.collectivegroup_id = collectivegroupid
                            )
                        GROUP BY
                            ( to_date(currentdate) ),
                            office_name,
                            group_name,
                            group_id,
                            ( to_date(currentdate) )
                    )
                WHERE
                    ROWNUM <= 36
                ORDER BY
                    ROWNUM DESC
            );

    ELSE
        SELECT
            pd_calculation("PERIOD", "TOTAL_LOAN_PORTFOLIO", "FROM_1_30_DPD", "FROM_31_60_DPD", "FROM_61_90_DPD",
                           "MORE_TAHN_90_DPD", "OFFICE_NAME", "GROUP_NAME",  "GROUP_ID", "PERIOD_2", "FROM_1_30_DPD_RATE",
                           "FROM_31_60_DPD_RATE", "FROM_61_90_DPD_RATE", "MORE_THAN_90_DPD_RATE")
        BULK COLLECT
        INTO return_value
        FROM
            (
                SELECT
                    *
                FROM
                    (
                        SELECT
                            NULL                                            period,
                            NULL                                            total_loan_portfolio,
                            NULL                                            from_1_30_dpd,
                            NULL                                            from_31_60_dpd,
                            NULL                                            from_61_90_dpd,
                            NULL                                            more_tahn_90_dpd,
                            '***WARNING MESSAGE***'                         office_name,
                            'PLEASE SELECT DATE BEFORE OR IN CURRENCT TILL' group_name,
                            NULL                                            GROUP_ID,
                            NULL                                            period_2,
                            NULL                                            from_1_30_dpd_rate,
                            NULL                                            from_31_60_dpd_rate,
                            NULL                                            from_61_90_dpd_rate,
                            NULL                                            more_than_90_dpd_RATE
                        FROM
                            dual
                    )
            );

    END IF;

    RETURN return_value;
END;

------------------------------------
create or replace FUNCTION CALCULATE_TOTAL_AVGOF_DPD_RATE (
AVG1 IN NUMBER,
AVG2 IN NUMBER,
AVG3 IN NUMBER,
AVG4 IN NUMBER,
THEGROUPLOANID IN NUMBER
) RETURN NUMBER IS RESULTTOTALAVG NUMBER(38, 2) := 0;
PAVG1 NUMBER(38, 5) := AVG1; PAVG2 NUMBER(38, 5) := AVG2; 
PAVG3 NUMBER(38, 5) := AVG3; PAVG4 NUMBER(38, 5) := AVG4;
BEGIN
    IF THEGROUPLOANID = 2 THEN PAVG1 := 1;
    ELSIF THEGROUPLOANID = 3 THEN PAVG1 := 1; PAVG2 := 1;
    ELSIF THEGROUPLOANID = 4 OR THEGROUPLOANID = 5 THEN PAVG1 := 1; PAVG2 := 1; PAVG3 := 1;
    END IF;
    SELECT 
    PAVG1 * PAVG2 * PAVG3 * PAVG4 
    INTO  RESULTTOTALAVG FROM DUAL;
    RETURN RESULTTOTALAVG;

END;

-------------------------------------------

create or replace FUNCTION "IMPAIRMENT_CALCULATION_REPORT" (
PLOANACCOUNT IN VARCHAR2,
PCURRENCTDATE IN DATE,
PISAIR IN NUMBER,
PTHEGROUPLOANID IN NUMBER
) RETURN IMPAIRMENT_CALCULATION_TABLE IS
RETURN_VALUE IMPAIRMENT_CALCULATION_TABLE;
INDEX_COUNTER NUMBER(38, 0) := 0;
BEGIN
--
--LOOP
--    INDEX_COUNTER := INDEX_COUNTER + 1;
--    IF INDEX_COUNTER > 8 THEN EXIT;
--    END IF;
--    dbms_output.put_line( 'Inside loop: ' || INDEX_COUNTER )  ;
    SELECT 
        IMPAIRMENT_CALCULATION(
            "LOAN_GROUP_ID", "LOAN_GROUP_NAME",
            "AVGOF_FROM_1_30_DPD_RATE" , "AVGOF_FROM_31_60_DPD_RATE",
            "AVGOF_FROM_61_90_DPD_RATE", "AVGOF_MORE_THAN_90_DPD_RATE",
            "TOTAL_AVGOF_DPD_RATE", "LGD_OFFICE_RATE",
            "EAD_NET_OUTSTANDING_LAON", "IMPAIRMENT"

        ) bulk collect
        INTO RETURN_VALUE
        FROM(

        
        
        select 
        null LOAN_GROUP_ID,
        null LOAN_GROUP_NAME,
        avg(FROM_1_30_DPD_RATE) AVGOF_FROM_1_30_DPD_RATE ,
        avg(FROM_31_60_DPD_RATE) AVGOF_FROM_31_60_DPD_RATE ,
        AVG(FROM_61_90_DPD_RATE) AVGOF_FROM_61_90_DPD_RATE,
        AVG(MORE_THAN_90_DPD_RATE) AVGOF_MORE_THAN_90_DPD_RATE,
        CALCULATE_TOTAL_AVGOF_DPD_RATE(
            avg(FROM_1_30_DPD_RATE),
            avg(FROM_31_60_DPD_RATE),
            AVG(FROM_61_90_DPD_RATE),
            AVG(MORE_THAN_90_DPD_RATE),
            PTHEGROUPLOANID
            )  TOTAL_AVGOF_DPD_RATE,
        get_lgd_rate(mlgd.officeid, mlgd.currency_code) LGD_OFFICE_RATE,
        vcifrs.netprincipal_oustanding EAD_NET_OUTSTANDING_LAON,
        CALCULATE_TOTAL_AVGOF_DPD_RATE(
        avg(FROM_1_30_DPD_RATE),
        avg(FROM_31_60_DPD_RATE),
        AVG(FROM_61_90_DPD_RATE),
        AVG(MORE_THAN_90_DPD_RATE),
        PTHEGROUPLOANID
        ) * 
        get_lgd_rate(mlgd.officeid, mlgd.currency_code)
          * 
          CASE
          WHEN PISAIR = 0 THEN vcifrs.netprincipal_oustanding
          WHEN PISAIR = 1 THEN GET_AIR(ML.ID, PCURRENCTDATE, PTHEGROUPLOANID)
          END IMPAIRMENT
        from M_LOAN ML
        
        INNER JOIN M_LOAN_LGD MLGD ON MLGD.LOANACCOUNT = ml.account_no
        INNER JOIN v_loan_cifrs VCIFRS ON vcifrs.loan_account = ml.account_no
        INNER JOIN m_collectivegroup MCG ON MCG.ID = ml.collectivegroup_id
        INNER JOIN
        table(pd_calculation_report(
        PCURRENCTDATE,
        ML.COLLECTIVEGROUP_ID,
        MLGD.OFFICEID
        )) TABLE_PD ON TABLE_PD.GROUP_ID = ml.collectivegroup_id
        WHERE ml.account_no = PLOANACCOUNT
        --AND mlgd.officeid = POFFICEID 
        group by GET_AIR(ML.ID, PCURRENCTDATE, PTHEGROUPLOANID), get_lgd_rate(mlgd.officeid, mlgd.currency_code), vcifrs.netprincipal_oustanding
);

--RETURN RETURN_VALUE;
--END LOOP;
RETURN RETURN_VALUE;
END;

----------------------------------------------------------

create or replace FUNCTION IMPAIRMENT_CALCULATION_FINALIZE_RESULT_REPORT(
PLOANACCOUNT IN VARCHAR2,
PCURRENCTDATE IN DATE,
PISAIR IN NUMBER
) RETURN IMPAIRMENT_CALCULATION_TABLE IS
RETURN_VALUE IMPAIRMENT_CALCULATION_TABLE;
ISLATE NUMBER(38, 0) := 0;
LATESINCE DATE := PCURRENCTDATE;
LOANID NUMBER := 0;
BEGIN
SELECT ID INTO LOANID FROM M_LOAN WHERE ACCOUNT_NO = PLOANACCOUNT;
SELECT COUNT(*) INTO ISLATE  FROM m_loan_arrears_aging MLA
INNER JOIN M_LOAN ML ON ML.ID = MLA.LOAN_ID
WHERE ML.ACCOUNT_NO = PLOANACCOUNT;

IF ISLATE > 0 THEN
SELECT overdue_since_date_derived INTO LATESINCE  FROM m_loan_arrears_aging MLA
INNER JOIN M_LOAN ML ON ML.ID = MLA.LOAN_ID
WHERE ML.ACCOUNT_NO = PLOANACCOUNT;
END IF;

SELECT 
    IMPAIRMENT_CALCULATION(
            "LOAN_GROUP_ID", "LOAN_GROUP_NAME",
            "AVGOF_FROM_1_30_DPD_RATE" , "AVGOF_FROM_31_60_DPD_RATE",
            "AVGOF_FROM_61_90_DPD_RATE", "AVGOF_MORE_THAN_90_DPD_RATE",
            "TOTAL_AVGOF_DPD_RATE", "LGD_OFFICE_RATE",
            "EAD_NET_OUTSTANDING_LAON", "IMPAIRMENT"

        ) bulk collect
        INTO RETURN_VALUE
        FROM(

            SELECT 
            1 LOAN_GROUP_ID,
            'CURRENT' LOAN_GROUP_NAME,
            AVGOF_FROM_1_30_DPD_RATE AVGOF_FROM_1_30_DPD_RATE,
            AVGOF_FROM_31_60_DPD_RATE AVGOF_FROM_31_60_DPD_RATE,
            AVGOF_FROM_61_90_DPD_RATE AVGOF_FROM_61_90_DPD_RATE,
            AVGOF_MORE_THAN_90_DPD_RATE AVGOF_MORE_THAN_90_DPD_RATE,
            TOTAL_AVGOF_DPD_RATE TOTAL_AVGOF_DPD_RATE,
            LGD_OFFICE_RATE LGD_OFFICE_RATE,
            CASE
            WHEN ISLATE = 0 THEN
                CASE 
                WHEN PISAIR = 0 THEN EAD_NET_OUTSTANDING_LAON 
                WHEN PISAIR = 1 THEN GET_AIR(LOANID, PCURRENCTDATE, 1)
                END
            ELSE NULL
            END EAD_NET_OUTSTANDING_LAON,
            CASE
            WHEN ISLATE = 0 THEN
            IMPAIRMENT 
            ELSE NULL
            END IMPAIRMENT
            FROM TABLE(IMPAIRMENT_CALCULATION_REPORT(
            PLOANACCOUNT,
            PCURRENCTDATE,
            PISAIR,
            1
            ))
--1----------------  
-------------------
            union
            SELECT 
            2 LOAN_GROUP_ID,
            '1 - 30 DPD' LOAN_GROUP_NAME,
            null AVGOF_FROM_1_30_DPD_RATE,
            AVGOF_FROM_31_60_DPD_RATE AVGOF_FROM_31_60_DPD_RATE,
            AVGOF_FROM_61_90_DPD_RATE AVGOF_FROM_61_90_DPD_RATE,
            AVGOF_MORE_THAN_90_DPD_RATE AVGOF_MORE_THAN_90_DPD_RATE,
            TOTAL_AVGOF_DPD_RATE TOTAL_AVGOF_DPD_RATE,
            LGD_OFFICE_RATE LGD_OFFICE_RATE,
            CASE
            WHEN ISLATE > 0 THEN
                CASE
                    WHEN TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE) >= 1 
                    AND TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE)<= 30
                    THEN 
                        CASE
                        WHEN PISAIR = 0 THEN EAD_NET_OUTSTANDING_LAON
                        WHEN PISAIR = 1 THEN GET_AIR(LOANID, PCURRENCTDATE, 2)
                        END
                    ELSE NULL END
            END EAD_NET_OUTSTANDING_LAON,
            CASE
            WHEN ISLATE > 0 THEN
                CASE
                    WHEN TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE) >= 1 
                    AND TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE)<= 30
                    THEN IMPAIRMENT 
                    ELSE NULL END
             END IMPAIRMENT
            FROM TABLE(IMPAIRMENT_CALCULATION_REPORT(
            PLOANACCOUNT,
            PCURRENCTDATE,
            PISAIR,
            2
            ))
--2---------------------
------------------------
            union
            SELECT 
            3 LOAN_GROUP_ID,
            '31 - 60 DPD' LOAN_GROUP_NAME,
            null AVGOF_FROM_1_30_DPD_RATE,
            null AVGOF_FROM_31_60_DPD_RATE,
            AVGOF_FROM_61_90_DPD_RATE AVGOF_FROM_61_90_DPD_RATE,
            AVGOF_MORE_THAN_90_DPD_RATE AVGOF_MORE_THAN_90_DPD_RATE,
            TOTAL_AVGOF_DPD_RATE TOTAL_AVGOF_DPD_RATE,
            LGD_OFFICE_RATE LGD_OFFICE_RATE,
            CASE
            WHEN ISLATE > 0 THEN
                CASE
                    WHEN TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE) >= 31 
                    AND TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE)<= 60
                    THEN 
                        CASE
                            WHEN PISAIR = 0 THEN EAD_NET_OUTSTANDING_LAON
                            WHEN PISAIR = 1 THEN GET_AIR(LOANID, PCURRENCTDATE, 3)
                            END
                    ELSE NULL END
             END EAD_NET_OUTSTANDING_LAON,
            CASE
            WHEN ISLATE > 0 THEN
                CASE
                    WHEN TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE) >= 31 
                    AND TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE)<= 60
                    THEN IMPAIRMENT 
                    ELSE NULL END
             END IMPAIRMENT
            FROM TABLE(IMPAIRMENT_CALCULATION_REPORT(
            PLOANACCOUNT,
            PCURRENCTDATE,
            PISAIR,
            3
            ))
--3--------------------
-----------------------
            union
            SELECT 
            4 LOAN_GROUP_ID,
            '61 - 90 DPD' LOAN_GROUP_NAME,
            null AVGOF_FROM_1_30_DPD_RATE,
            null AVGOF_FROM_31_60_DPD_RATE,
            null AVGOF_FROM_61_90_DPD_RATE,
            AVGOF_MORE_THAN_90_DPD_RATE AVGOF_MORE_THAN_90_DPD_RATE,
            TOTAL_AVGOF_DPD_RATE TOTAL_AVGOF_DPD_RATE,
            LGD_OFFICE_RATE LGD_OFFICE_RATE,
            CASE
            WHEN ISLATE > 0 THEN
                CASE
                    WHEN TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE) >= 61 
                    AND TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE)<= 90
                    THEN
                        CASE
                        WHEN PISAIR = 0 THEN EAD_NET_OUTSTANDING_LAON
                        WHEN PISAIR = 1 THEN GET_AIR(LOANID, PCURRENCTDATE, 4)
                        END
                    ELSE NULL END
             END EAD_NET_OUTSTANDING_LAON,
            CASE
            WHEN ISLATE > 0 THEN
                CASE
                    WHEN TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE) >= 61 
                    AND TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE)<= 90
                    THEN IMPAIRMENT 
                    ELSE NULL END
             END IMPAIRMENT
            FROM TABLE(IMPAIRMENT_CALCULATION_REPORT(
            PLOANACCOUNT,
            PCURRENCTDATE,
            PISAIR,
            4
            ))
--4-----------------------
--------------------------
            union
            SELECT 
            5 LOAN_GROUP_ID,
            'MORE THAN 90' LOAN_GROUP_NAME,
            null AVGOF_FROM_1_30_DPD_RATE,
            null AVGOF_FROM_31_60_DPD_RATE,
            null AVGOF_FROM_61_90_DPD_RATE,
            AVGOF_MORE_THAN_90_DPD_RATE AVGOF_MORE_THAN_90_DPD_RATE,
            TOTAL_AVGOF_DPD_RATE TOTAL_AVGOF_DPD_RATE,
            LGD_OFFICE_RATE LGD_OFFICE_RATE,
             CASE
            WHEN ISLATE > 0 THEN
                CASE
                    WHEN TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE) > 90 
                    THEN 
                        CASE
                        WHEN PISAIR = 0 THEN EAD_NET_OUTSTANDING_LAON
                        WHEN PISAIR = 1 THEN GET_AIR(LOANID, PCURRENCTDATE, 5)
                        END
                    ELSE NULL END
             END EAD_NET_OUTSTANDING_LAON,
            CASE
            WHEN ISLATE > 0 THEN
                CASE
                    WHEN TO_DATE(PCURRENCTDATE) -  TO_DATE(LATESINCE) > 90 
                    THEN IMPAIRMENT 
                    ELSE NULL END
             END IMPAIRMENT
            FROM TABLE(IMPAIRMENT_CALCULATION_REPORT(
            PLOANACCOUNT,
            PCURRENCTDATE,
            PISAIR,
            5
            ))
        ) order by LOAN_GROUP_ID;
RETURN RETURN_VALUE;
END;

---------------------------------------------


create or replace FUNCTION GET_AIR(
LOANID IN NUMBER,
CURRENTDATE IN DATE,
THEGROUPLOANID IN NUMBER
) RETURN NUMBER IS RESULT_AIR NUMBER(38, 2) := 0;

BEGIN

    SELECT
    CASE 
    WHEN THEGROUPLOANID = 1 THEN totalloanportfolio 
    WHEN THEGROUPLOANID = 2 THEN to30dpd
    WHEN THEGROUPLOANID = 3 THEN to60dpd
    WHEN THEGROUPLOANID = 4 THEN to90dpd
    WHEN THEGROUPLOANID = 5 THEN morethan90dpd
    END AIR INTO RESULT_AIR



    FROM (
             SELECT
    last_day(to_date(  CURRENTDATE)) AS period,
    nvl(SUM(
        CASE
            WHEN pd = 'PD0' THEN
                nvl(outstanding, 0)
            ELSE
                0
        END
    ), 0) AS totalloanportfolio,
    nvl(SUM(
        CASE
            WHEN pd = 'PD1' THEN
                nvl(outstanding, 0)
            ELSE
                0
        END
    ), 0) AS to30dpd,
    nvl(SUM(
        CASE
            WHEN pd = 'PD2' THEN
                nvl(outstanding, 0)
            ELSE
                0
        END
    ), 0) AS to60dpd,
    nvl(SUM(
        CASE
            WHEN pd = 'PD3' THEN
                nvl(outstanding, 0)
            ELSE
                0
        END
    ), 0) AS to90dpd,
    nvl(SUM(
        CASE
            WHEN pd = 'PD4' THEN
                nvl(outstanding, 0)
            ELSE
                0
        END
    ), 0) AS morethan90dpd
FROM
    (
        SELECT
            CASE
                WHEN to_date(  CURRENTDATE) - nvl(to_date(vnsss.due_date), to_date(  CURRENTDATE)) BETWEEN 1 AND 30 THEN
                    'PD1'
                WHEN to_date(  CURRENTDATE) - nvl(to_date(vnsss.due_date), to_date(  CURRENTDATE)) BETWEEN 31 AND 60 THEN
                    'PD2'
                WHEN to_date(  CURRENTDATE) - nvl(to_date(vnsss.due_date), to_date(  CURRENTDATE)) BETWEEN 61 AND 90 THEN
                    'PD3'
                WHEN to_date(  CURRENTDATE) - nvl(to_date(vnsss.due_date), to_date(  CURRENTDATE)) > 90          THEN
                    'PD4'
                WHEN to_date(  CURRENTDATE) - nvl(to_date(vnsss.due_date), to_date(  CURRENTDATE)) < 1            THEN
                    'PD0'
            END AS pd,
            vns.accrued_interest AS outstanding
        FROM
            v_new_schedule                                                                                                           vns
            JOIN (
                SELECT
                    id             AS id,
                    loancifrs_id   AS loancifrs_id
                FROM
                    v_new_schedule
                WHERE
                    schedule_status <> 2
                    AND nvl(accrued_interest, 0) > 0
            ) vnss ON vnss.id = vns.id
                      AND vnss.loancifrs_id = vns.loancifrs_id
            JOIN m_loan                                                                                                                   ml ON ml.account_no = vns.loan_account
            JOIN (
                SELECT
                    MIN(due_date) AS due_date,
                    loancifrs_id AS loancifrs_id
                FROM
                    v_new_schedule
                WHERE
                    schedule_status <> 2
                GROUP BY
                    loancifrs_id
            ) vnsss ON vns.loancifrs_id = vnsss.loancifrs_id
        WHERE
            ml.loan_status_id = 300
            AND vns.loancifrs_id =   LOANID
    )
        );

        RETURN RESULT_AIR;

END;

----------------------------

create or replace FUNCTION GET_LGD_RATE (
POFFICEID IN NUMBER,
PCURRENCYCODE IN VARCHAR2
) RETURN NUMBER IS RESULTLGDRATE NUMBER(38, 10) := 0;

BEGIN
    SELECT LGDRATE INTO  RESULTLGDRATE FROM M_LGD_OFFICE 
    WHERE OFFICEID =  POFFICEID 
    AND CURRENCY_CODE = PCURRENCYCODE;
    RETURN RESULTLGDRATE;
END;

